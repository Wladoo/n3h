#!/usr/bin/env node

const { Pitr } = require('../lib/index')

const nvPersistSqlite3 = require('n3h-mod-nv-persist-sqlite3')

async function main () {
  const pitr = await new Pitr([
    nvPersistSqlite3
  ])

  let terminated = false
  const terminate = async () => {
    if (terminated) {
      return
    }
    try {
      await pitr.destroy()
      console.log('n3h exited cleanly')
      process.exit(0)
    } catch (e) {
      console.error(e.stack || e.toString())
      process.exit(1)
    }
  }

  process.on('SIGINT', terminate)
  process.on('SIGTERM', terminate)

  await pitr.run()
}

main().then(() => {}, (err) => {
  console.error(err)
  process.exit(1)
})
